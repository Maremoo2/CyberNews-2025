name: Daily Digest

on:
  schedule:
    # Run every day at 22:00 UTC (after news collection)
    - cron: '0 22 * * *'
  workflow_dispatch:
    # Allow manual triggering

concurrency:
  group: daily-digest-${{ github.event.schedule || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: write

jobs:
  digest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check if digest already exists
        id: check-existing
        run: |
          TODAY=$(date +%Y-%m-%d)
          if [ -f "public/data/daily/${TODAY}.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Digest for $TODAY already exists. Skipping."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run daily digest
        id: daily-digest
        if: steps.check-existing.outputs.exists == 'false'
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: npm run daily-digest
      
      - name: Check for changes
        id: git-check
        run: |
          TODAY=$(date +%Y-%m-%d)
          echo "date=$TODAY" >> $GITHUB_OUTPUT
          
          # Check if digest file was created
          if [ -f "public/data/daily/${TODAY}.json" ]; then
            git add "public/data/daily/${TODAY}.json"
            echo "digest_created=true" >> $GITHUB_OUTPUT
          elif [ -f "public/data/daily/${TODAY}_pending.json" ]; then
            git add "public/data/daily/${TODAY}_pending.json"
            echo "digest_created=pending" >> $GITHUB_OUTPUT
          else
            echo "digest_created=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if there are staged changes
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push with smart conflict resolution
        if: steps.git-check.outputs.changed == 'true'
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TODAY="${{ steps.git-check.outputs.date }}"
          DIGEST_STATUS="${{ steps.git-check.outputs.digest_created }}"
          
          if [ "$DIGEST_STATUS" == "true" ]; then
            COMMIT_MSG="chore: add daily digest for $TODAY"
          else
            COMMIT_MSG="chore: add daily digest pending marker for $TODAY (quota exceeded)"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          # Enhanced retry with conflict detection
          MAX_RETRIES=5
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Attempt $attempt/$MAX_RETRIES: fetch + rebase + push"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Fetch latest
            git fetch origin main
            
            # Check what changed upstream
            echo "ğŸ“Š Upstream changes since our commit:"
            git log HEAD..origin/main --oneline --no-decorate || true
            
            # Try rebase with conflict detection
            if git rebase origin/main 2>&1 | tee /tmp/rebase_output.txt; then
              echo "âœ… Rebase succeeded"
            else
              echo "âš ï¸ Rebase failed. Analyzing conflicts..."
              
              # Check for actual conflicts
              if grep -q "CONFLICT" /tmp/rebase_output.txt; then
                echo "ğŸ”¥ MERGE CONFLICT DETECTED"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                
                # Show what files are conflicting
                git status --short || true
                
                # For daily JSON files, use our version (they should be identical)
                if [ -f "public/data/daily/${TODAY}.json" ]; then
                  echo "ğŸ“ Resolving conflict for public/data/daily/${TODAY}.json using 'ours' strategy"
                  git checkout --ours "public/data/daily/${TODAY}.json"
                  git add "public/data/daily/${TODAY}.json"
                  
                  # Show diff for logging
                  echo "ğŸ“‹ Difference between versions:"
                  git diff origin/main:public/data/daily/${TODAY}.json HEAD:public/data/daily/${TODAY}.json || echo "Files are identical"
                fi
                
                # Continue rebase
                if git rebase --continue; then
                  echo "âœ… Conflict resolved, rebase continued"
                else
                  echo "âŒ Could not continue rebase. Aborting..."
                  git rebase --abort
                  sleep $((attempt * 3 + RANDOM % 5))
                  continue
                fi
              else
                echo "âŒ Rebase failed for non-conflict reason"
                git rebase --abort
                sleep $((attempt * 3))
                continue
              fi
            fi
            
            # Try to push
            echo "ğŸ“¤ Attempting push..."
            if git push origin HEAD:main; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… SUCCESS: Push completed on attempt $attempt"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 0
            fi
            
            echo "âš ï¸ Push rejected. Repository changed during our attempt."
            
            # Add jitter to backoff
            BACKOFF=$((attempt * 3 + RANDOM % 5))
            echo "â³ Backing off for ${BACKOFF}s before retry..."
            sleep $BACKOFF
          done
          
          # If we get here, all retries failed
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ FAILURE: All $MAX_RETRIES push attempts failed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” DEBUGGING INFO:"
          echo "  - Date: $TODAY"
          echo "  - File: public/data/daily/${TODAY}.json"
          echo "  - Concurrent workflows may be modifying the same file"
          echo ""
          echo "ğŸ“‹ Recent commits on main:"
          git fetch origin main
          git log origin/main -10 --oneline --no-decorate || true
          echo ""
          echo "ğŸ’¡ NEXT STEPS:"
          echo "  1. Check for other running workflows in Actions tab"
          echo "  2. Look for patterns in the commit history above"
          echo "  3. Consider manually resolving if this persists"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
      
      - name: Log deployment trigger
        if: steps.git-check.outputs.changed == 'true'
        run: |
          echo "âœ… Data committed successfully"
          echo "ğŸš€ Triggering deployment workflow..."
          echo "Files will be available at: https://maremoo2.github.io/CyberNews-2025/"
      
      - name: Trigger deployment
        if: steps.git-check.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'deploy.yml',
                ref: 'main'
              });
              console.log('âœ… Deployment workflow triggered successfully');
            } catch (error) {
              console.error('âŒ Failed to trigger deployment workflow:', error.message);
              throw error;
            }